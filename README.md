# ğŸŒŸ DinoDB-Technical-File

DinoDBæ˜¯ä¸€ä¸ªç®€å•è€Œé«˜æ•ˆçš„æ•°æ®åº“ç³»ç»Ÿå®ç°ï¼Œä¸»è¦å…³æ³¨æ•°æ®åº“çš„æ ¸å¿ƒç»„ä»¶å’Œå¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚

> **æ³¨æ„**: æœ¬ä»“åº“åŒ…å«çš„æ˜¯DinoDBç³»ç»Ÿçš„æŠ€æœ¯æ–‡æ¡£å’Œå¯æ‰§è¡Œæˆæœç‰©ï¼Œè€Œéå®Œæ•´æºä»£ç ã€‚è¿™äº›æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ç³»ç»Ÿæ¶æ„ã€ç®—æ³•å®ç°å’Œå…³é”®ç»„ä»¶çš„å·¥ä½œåŸç†ã€‚ä»“åº“ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆdinodb.exe, dinodb_client.exe, dinodb_stress.exeï¼‰å¯ç›´æ¥è¿è¡Œä½¿ç”¨ï¼Œæ— éœ€é¢å¤–ç¼–è¯‘ã€‚

## ğŸ“š æ–‡æ¡£è¯´æ˜

æœ¬é¡¹ç›®åŒ…å«ä»¥ä¸‹æŠ€æœ¯æ–‡æ¡£ï¼š

- **B+ Tree.md** - è¯¦ç»†ä»‹ç»B+æ ‘ç´¢å¼•ç»“æ„å®ç°ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹ç»“æ„ã€æ’å…¥ã€æŸ¥è¯¢å’Œå¹¶å‘æ§åˆ¶æœºåˆ¶
- **Concurrency for B+ Tree.md** - è¯´æ˜B+æ ‘çš„å¹¶å‘æ§åˆ¶å®ç°ï¼Œé‡ç‚¹ä»‹ç»æ‚²è§‚é”çˆ¬è¡Œç­–ç•¥
- **Join.md** - è®²è§£åŸºäºå¸ƒéš†è¿‡æ»¤å™¨çš„å“ˆå¸Œè¿æ¥ç®—æ³•å®ç°å’Œä¼˜åŒ–
- **Pager.md** - æè¿°é¡µé¢ç®¡ç†å™¨çš„è®¾è®¡ï¼ŒåŒ…æ‹¬LRUç¼“å­˜æœºåˆ¶å’Œé¡µé¢æ›¿æ¢ç­–ç•¥
- **Transaction.md** - é˜è¿°äº‹åŠ¡ç®¡ç†å™¨å’Œå¹¶å‘æ§åˆ¶è®¾è®¡ï¼ŒåŒ…æ‹¬2PLåè®®å’Œæ­»é”æ£€æµ‹

## ğŸš€ é¡¹ç›®ç‰¹ç‚¹
* **ğŸ“Š æ•°æ®ç»“æ„**ï¼šåŸºäºB+æ ‘çš„ç´¢å¼•ç»“æ„ï¼Œæ”¯æŒé«˜æ•ˆçš„æŸ¥è¯¢å’ŒèŒƒå›´æ‰«æ
* **ğŸ”„ å¹¶å‘æ§åˆ¶**ï¼šä½¿ç”¨äº‹åŠ¡ç®¡ç†å™¨å®ç°ä¸¥æ ¼çš„2PLï¼ˆä¸¤é˜¶æ®µé”å®šï¼‰åè®®ï¼Œç¡®ä¿äº‹åŠ¡çš„éš”ç¦»æ€§
* **ğŸ’¾ é¡µé¢ç®¡ç†**ï¼šå®ç°LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç¼“å­˜æœºåˆ¶çš„é¡µé¢ç®¡ç†å™¨ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨
* **ğŸ” è¿æ¥ç®—æ³•**ï¼šåŸºäºåˆ†åŒºå“ˆå¸Œè¿æ¥çš„é«˜æ•ˆæŸ¥è¯¢å¤„ç†ï¼Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¼˜åŒ–æ€§èƒ½

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### ğŸŒ² B+æ ‘ç´¢å¼•
B+æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼Œæ”¯æŒé«˜æ•ˆçš„æ’å…¥ã€åˆ é™¤å’ŒèŒƒå›´æŸ¥è¯¢æ“ä½œã€‚åœ¨æœ¬é¡¹ç›®ä¸­å®ç°çš„B+æ ‘å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
* åº¦æ•°(degree)ä¸º202ï¼Œå…è®¸æ›´é«˜çš„åˆ†æ”¯å› å­å‡å°‘æ ‘é«˜
* æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œå†…éƒ¨èŠ‚ç‚¹åªå­˜å‚¨ç´¢å¼•é”®
* å¶å­èŠ‚ç‚¹é€šè¿‡å³å…„å¼ŸæŒ‡é’ˆè¿æ¥ï¼Œæ”¯æŒé«˜æ•ˆçš„é¡ºåºæ‰«æ

æ”¯æŒçš„æ“ä½œï¼š
* æ’å…¥ï¼ˆInsertï¼‰
* æŸ¥æ‰¾ï¼ˆFindï¼‰
* æ›´æ–°ï¼ˆUpdateï¼‰
* åˆ é™¤ï¼ˆDeleteï¼‰
* èŒƒå›´æŸ¥è¯¢ï¼ˆSelectRangeï¼‰
* å…¨é‡æŸ¥è¯¢ï¼ˆSelectï¼‰

**å¹¶å‘æ§åˆ¶ï¼š** é‡‡ç”¨æ‚²è§‚é”çˆ¬è¡Œç­–ç•¥ï¼Œå…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼ŒåŒæ—¶ä¸å†™æ“ä½œäº’æ–¥ã€‚

### ğŸ“ é¡µé¢ç®¡ç†å™¨ï¼ˆPagerï¼‰
Pagerè´Ÿè´£ç®¡ç†å†…å­˜ä¸­çš„æ•°æ®é¡µä¸ç£ç›˜æ–‡ä»¶çš„äº¤äº’ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š
* å®ç°LRUç¼“å­˜æœºåˆ¶ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨
* é€šè¿‡PinnedListã€UnpinnedListå’ŒFreeListç®¡ç†é¡µé¢çŠ¶æ€
* æä¾›é¡µé¢è·å–ã€é‡Šæ”¾å’Œåˆ·æ–°æ¥å£

LRUç­–ç•¥ï¼š
* æ–°è®¿é—®çš„é¡µé¢æ”¾å…¥pinnedListå°¾éƒ¨ï¼ˆæœ€è¿‘ä½¿ç”¨ï¼‰
* ä¸å†ä½¿ç”¨çš„é¡µé¢æ”¾å…¥unpinnedListå°¾éƒ¨ï¼ˆæœ€è¿‘ä½¿ç”¨ä½†å€™é€‰æ·˜æ±°ï¼‰
* éœ€è¦æ–°é¡µé¢æ—¶ä»freeListæˆ–unpinnedListå¤´éƒ¨ï¼ˆæœ€ä¹…æœªä½¿ç”¨ï¼‰è·å–

### ğŸ” äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTransaction Managerï¼‰
å®ç°åŸºäºä¸¥æ ¼2PLåè®®çš„äº‹åŠ¡ç®¡ç†ï¼Œç¡®ä¿æ•°æ®åº“çš„ACIDç‰¹æ€§ï¼š
* é€šè¿‡ResourceLockManagerç®¡ç†èµ„æºä¸é”çš„æ˜ å°„å…³ç³»
* ä½¿ç”¨WaitsForGraphè¿›è¡Œæ­»é”æ£€æµ‹
* æ”¯æŒäº‹åŠ¡çš„å¼€å§‹ã€æäº¤ã€å›æ»šä»¥åŠé”å®š/è§£é”æ“ä½œ

ä¸»è¦ç»„ä»¶ï¼š
* **ResourceLockManager**ï¼šç®¡ç†èµ„æºä¸å¯¹åº”äº’æ–¥é”çš„æ˜ å°„
* **WaitsForGraph**ï¼šé€šè¿‡å›¾ç®—æ³•æ£€æµ‹äº‹åŠ¡é—´çš„æ­»é”
* **Transactions Map**ï¼šç»´æŠ¤æ´»è·ƒäº‹åŠ¡åŠå…¶æŒæœ‰çš„èµ„æºé”

### ğŸ”„ è¿æ¥ç®—æ³•ï¼ˆJoinï¼‰
åŸºäºåˆ†åŒºå“ˆå¸Œè¿æ¥çš„å®ç°ï¼Œç‰¹ç‚¹ï¼š
* é€šè¿‡å“ˆå¸Œå‡½æ•°å¯¹è¡¨æ•°æ®è¿›è¡Œåˆ†åŒº
* ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¼˜åŒ–æ¢æµ‹é˜¶æ®µæ€§èƒ½
* æ”¯æŒkey-key, key-value, value-keyç­‰å¤šç§è¿æ¥æ¨¡å¼

å·¥ä½œæµç¨‹ï¼š
1. æ„å»ºé˜¶æ®µï¼šåˆ›å»ºå·¦å³è¡¨çš„ä¸´æ—¶å“ˆå¸Œç´¢å¼•
2. æ¢æµ‹é˜¶æ®µï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨å’Œå“ˆå¸Œè¡¨æŸ¥æ‰¾åŒ¹é…è®°å½•

## âœ¨ é¡¹ç›®ç‰¹è‰²
* **âš¡ é«˜æ•ˆæ€§èƒ½**ï¼šB+æ ‘ç´¢å¼•å’Œå“ˆå¸Œè¿æ¥ç¡®ä¿æŸ¥è¯¢å¤„ç†çš„é«˜æ•ˆæ€§
* **ğŸ§µ è‰¯å¥½çš„å¹¶å‘æ”¯æŒ**ï¼šé€šè¿‡æ‚²è§‚é”çˆ¬è¡Œå’Œä¸¤é˜¶æ®µé”å®šå®ç°å¹¶å‘æ§åˆ¶
* **ğŸ”‹ å†…å­˜ä¼˜åŒ–**ï¼šLRUé¡µé¢ç¼“å­˜æœºåˆ¶æœ‰æ•ˆé™ä½ç£ç›˜I/O
* **ğŸ›¡ï¸ æ­»é”å¤„ç†**ï¼šé€šè¿‡ç­‰å¾…å›¾è¿›è¡Œæ­»é”æ£€æµ‹å’Œå¤„ç†

## ğŸ”§ ä½¿ç”¨æ–¹æ³•
### è¿è¡Œç¯å¢ƒ

DinoDBæ˜¯ä½¿ç”¨Goè¯­è¨€å¼€å‘çš„è‡ªåŒ…å«æ•°æ®åº“ç³»ç»Ÿï¼Œæä¾›çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥ç›´æ¥è¿è¡Œï¼š

- **æ“ä½œç³»ç»Ÿ**ï¼šæ”¯æŒLinuxã€macOSå’ŒWindows
- **ä¾èµ–**ï¼šä¸éœ€è¦é¢å¤–å®‰è£…Goè¯­è¨€ç¯å¢ƒæˆ–å…¶ä»–æ•°æ®åº“ç³»ç»Ÿ
- **æƒé™**ï¼šå¯èƒ½éœ€è¦ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆLinux/Macä¸‹ä½¿ç”¨`chmod +x`ï¼‰

### ç¼–è¯‘

å¦‚æœéœ€è¦ä»æºä»£ç ç¼–è¯‘ï¼ˆéå¿…éœ€ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æä¾›çš„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼š

```bash
# ç¼–è¯‘æœåŠ¡å™¨ç«¯
go build -buildvcs=false -o dinodb ./cmd/dinodb

# ç¼–è¯‘å®¢æˆ·ç«¯
go build -buildvcs=false -o dinodb_client ./cmd/dinodb_client

# ç¼–è¯‘å‹åŠ›æµ‹è¯•å·¥å…·
go build -buildvcs=false -o dinodb_stress ./cmd/dinodb_stress
```

### å¯åŠ¨æœåŠ¡å™¨

```bash
# å¯åŠ¨DinoDBæœåŠ¡å™¨ï¼ŒæŒ‡å®šé¡¹ç›®å’Œç«¯å£
./dinodb -project concurrency -p 8335
```

æœåŠ¡å™¨æˆåŠŸå¯åŠ¨åä¼šæ˜¾ç¤ºï¼š
```
dinodb server started listening on localhost:8335
```

### å¯åŠ¨å®¢æˆ·ç«¯

åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­å¯åŠ¨å®¢æˆ·ç«¯ï¼š

```bash
# è¿æ¥åˆ°æŒ‡å®šç«¯å£çš„DinoDBæœåŠ¡å™¨
./dinodb_client -p 8335
```

è¿æ¥æˆåŠŸåï¼Œæ‚¨å°†çœ‹åˆ°REPLç•Œé¢ï¼š
```
Welcome to the dinodb REPL! Please type '.help' to see the list of available commands.
dinodb> 
```

### å¯ç”¨å‘½ä»¤
ä½¿ç”¨ `.help` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤ï¼š

```
dinodb> .help
create: Create a table. usage: create table <table>
find: Find an element. usage: find <key> from <table>
update: Update en element. usage: update <table> <key> <value>
delete: Delete an element. usage: delete <key> from <table>
select: Select elements from a table. usage: select from <table>
transaction: Handle transactions. usage: transaction <begin|commit>
pretty: Print out the internal data representation. usage: pretty
insert: Insert an element. usage: insert <key> <value> into <table>
lock: Grabs a write lock on a resource. usage: lock <table> <key>
```

### å‘½ä»¤ä½¿ç”¨ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨æ“ä½œçš„ç¤ºä¾‹ï¼š

#### åˆ›å»ºè¡¨
```
dinodb> create btree table test
```

#### åªè¯»æ“ä½œ
ä»¥ä¸‹æ“ä½œä¸éœ€è¦äº‹åŠ¡åŒ…è£…ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯è¯»å–æ•°æ®ä¸ä¿®æ”¹æ•°æ®åº“çŠ¶æ€ï¼š
```
dinodb> find 2 from test
dinodb> select from test
dinodb> pretty from test
```

#### æŸ¥çœ‹æ•°æ®ç»“æ„
```
dinodb> pretty from test
[0] Leaf (root) size: 4
 |--> (1, 10)
 |--> (2, 20)
 |--> (3, 30)
 |--> (5, 500)
```

#### ä¿®æ”¹æ•°æ®çš„äº‹åŠ¡æ“ä½œ
æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„æ“ä½œéƒ½éœ€è¦åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼š

##### æ’å…¥æ•°æ®
```
dinodb> transaction begin
dinodb> insert 1 10 into test
dinodb> insert 2 20 into test
dinodb> insert 3 30 into test
dinodb> transaction commit
```

##### æ›´æ–°æ•°æ®
```
dinodb> transaction begin
dinodb> update test 2 25
dinodb> transaction commit
```

##### åˆ é™¤æ•°æ®
```
dinodb> transaction begin
dinodb> delete 3 from test
dinodb> transaction commit
```

##### å¤šæ“ä½œäº‹åŠ¡
```
dinodb> transaction begin
dinodb> insert 5 500 into test
dinodb> update test 1 15
dinodb> delete 3 from test
dinodb> transaction commit
```

#### ä½¿ç”¨é”ï¼ˆæ˜¾å¼é”å®šï¼‰
```
dinodb> transaction begin
dinodb> lock test 1
dinodb> lock test 2
// æ‰§è¡Œå…¶ä»–éœ€è¦è®¿é—®è¿™äº›èµ„æºçš„æ“ä½œ
// æ³¨æ„ï¼šé€šå¸¸ä¸éœ€è¦æ˜¾å¼åŠ é”ï¼Œå› ä¸ºæ“ä½œå¦‚updateå’Œdeleteä¼šè‡ªåŠ¨è·å–å¿…è¦çš„é”
dinodb> transaction commit
```

### æµ‹è¯•

```bash
# å®Œæ•´æµ‹è¯•ï¼ˆæ— ä»£ç ä¸èƒ½æµ‹è¯•ï¼‰
go test './test/concurrency/...' -race -timeout 180s -v

# å‹åŠ›æµ‹è¯•ï¼Œå¹¶å‘çº¿ç¨‹æ•°ä¸º8
./dinodb_stress -index=btree -workload=workloads/i-a-sm.txt -n=8 -verify

# å‹åŠ›æµ‹è¯•ï¼Œå¦‚æœä¸Šè¿°å‘½ä»¤æŠ¥é”™ï¼Œ	å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„
./dinodb_stress -index=btree -workload="C:\Users\huo00\OneDrive\Documents\DinoDB-Technical-File\workloads\i-i-md.txt" -n=8 -verify
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ
* **B+æ ‘æ’å…¥**ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¹±åºæ’å…¥æ¯”é¡ºåºæ’å…¥è¡¨ç°æ›´å¥½
* **è¿æ¥æ“ä½œ**ï¼šéšç€æ•°æ®é‡å¢åŠ ï¼Œæ‰§è¡Œæ—¶é—´å‘ˆçº¿æ€§å¢é•¿ï¼Œå¯¹ä¸åŒåŒ¹é…ç‡è¡¨ç°ç¨³å®š
* **Selectæ“ä½œ**ï¼šåœ¨1-8çº¿ç¨‹é—´æ€§èƒ½è¾ƒä¸ºç¨³å®šï¼Œä½†16çº¿ç¨‹æ—¶å‡ºç°æ€§èƒ½ä¸‹é™

## ğŸ“‚ é¡¹ç›®ç»“æ„
* **BTreeIndex**ï¼šB+æ ‘ç´¢å¼•å®ç°
* **Pager**ï¼šé¡µé¢ç®¡ç†å™¨
* **TransactionManager**ï¼šäº‹åŠ¡ç®¡ç†å’Œå¹¶å‘æ§åˆ¶
* **Join**ï¼šå“ˆå¸Œè¿æ¥ç®—æ³•å®ç°

## ğŸ”® æœªæ¥å±•æœ›
* æ·»åŠ ç´¢å¼•ç±»å‹æ”¯æŒ
* ä¼˜åŒ–å¤§è§„æ¨¡æ•°æ®å¤„ç†æ€§èƒ½

## ğŸ“« è·å–ä»£ç 
ç”±äºè¯¾ç¨‹è¦æ±‚ï¼ˆä¸èƒ½å¯¹æœªæ¥å­¦å¼Ÿå­¦å¦¹å…¬å¼€ä»£ç ï¼‰ï¼Œæºä»£ç æš‚æ—¶ä¸èƒ½å…¬å¼€ã€‚å¦‚æœä½ å¯¹é¡¹ç›®æ„Ÿå…´è¶£ï¼Œè¯·å‘é€é‚®ä»¶è‡³ huo000311@outlook.com ç´¢å–ä»£ç ã€‚
